<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AlloyPhoto Demo1</title>
    <style type="text/css">
    .imageBox {
        width: 99vw;
        height: 66vw;
        position: relative;
    }

    img#pic1 {
        position: absolute;
        width: 99vw;
        height: 66vw;
        top: 0;
        left: 0;
        z-index: 2;
    }

    img#pic2 {
        position: absolute;
        width: 30vw;
        left: 28vw;
        top: 3vw;
        z-index: 1;
    }

    img#pic4 {
        width: 800px;
    }

    .weui-slider-box {
        width: 90vw;
        margin: 10vh auto;
    }
    </style>
    <link rel="stylesheet" type="text/css" href="weui.min.css" />
    <script type="text/javascript" src="alloyimage.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
</head>

<body>
    <div class="imageBox">
        <img id="pic1" src="images/model.png" />
        <img id="pic2" />
    </div>
    <img id="pic4" src="images/demo.jpg" alt="" />
    <div class="weui-slider-box">
        <div class="weui-slider">
            <div id="sliderInner" class="weui-slider__inner">
                <div id="sliderTrack" style="width: 70%;" class="weui-slider__track"></div>
                <div id="sliderHandler" style="left: 70%; width:5vw; height:5vw; margin-top:-2.5vw; margin-left:-2.5vw;" class="weui-slider__handler"></div>
            </div>
        </div>
        <!-- <div id="sliderValue" class="weui-slider-box__value"></div> -->
    </div>
    <script type="text/javascript">
    var pic2_dom = document.getElementById("pic2");
    var pic3_dom = document.getElementById("pic3");
    var img_head = new Image(),
        img_skin = new Image(),
        $ai_skin,
        $ai_head;
    img_head.src = "images/3.png";
    img_skin.src = "images/skin.png";

    var picTranseObj,
        pic_origin,
        pic_dom = document.getElementById("pic4");
    var min = 50,
        max = 120,
        per = 70,
        level,
        $sliderHandler = $("#sliderHandler"),
        $sliderTrack = $("#sliderTrack"),
        $sliderValue = $("#sliderValue"),
        totalLen = $('#sliderInner').width(),
        startLeft = 0,
        startX = 0,
        timer;

    var img_loaded_count = 0,
        img_loaded = function() {
            if (++img_loaded_count < 2)
                return;

            $ai_skin = $AI(img_skin);
            $ai_head = $AI(img_head)//.add($ai_skin, "正片叠底");

            imgDeal2();
        },
        imgDeal2 = function() {
            var $ai_head_temp = $ai_head.clone();
            $ai_head_temp.ps("美肤", per).replace(pic2_dom);
        };

    if (img_head.complete)
        img_loaded();
    else {
        img_head.onload = function() {
            img_loaded();
        };
    }
    if (img_skin.complete)
        img_loaded();
    else {
        img_skin.onload = function() {
            img_loaded();
        };
    }

    var sliderListener = function() {

        $("#sliderHandler").on('touchstart', function(e) {
            startLeft = totalLen * per / 100;
            startX = e.originalEvent.touches[0].clientX;
            // console.log(parseInt($sliderHandler.css('left')),totalLen,startLeft, startX);
            e.preventDefault();
        }).on('touchmove', function(e) {
            // console.log(e.originalEvent.touches[0].clientX, startLeft);
            per = startLeft + e.originalEvent.touches[0].clientX - startX;
            per = per < 0 ? 0 : per > totalLen ? totalLen : per;
            per = parseInt(per / totalLen * 100);
            $sliderTrack.css('width', per + '%');
            $sliderHandler.css('left', per + '%');
            // $sliderValue.text(percent);

            clearTimeout(timer);
            timer = setTimeout(function() {
                imgDeal();
                imgDeal2();
            }, 500);

            e.preventDefault();
        }).on('touchend', function() {
            clearTimeout(timer);
            imgDeal();
            imgDeal2();
        })
    };

    var imgDeal = function() {

        picTranseObj = pic_origin.clone(); //克隆原始对象做为原始副本

        level = min + (max - min) * per / 100;
        var pic_new = picTranseObj.ps("美肤", level);
        pic_new.replace(pic_dom);

        $(pic_dom).on('touchstart', function() {
            pic_origin.replace(pic_dom);
        }).on('touchend', function() {
            pic_new.replace(pic_dom);
        });
    }

    pic_dom.loadOnce(function() {

        pic_origin = $AI(this); //创建一个psLib对象

        imgDeal();

        sliderListener();

    });
    </script>
</body>

</html>